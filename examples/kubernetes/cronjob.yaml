apiVersion: batch/v1
kind: CronJob
metadata:
  name: gcal-to-discord-sync
  namespace: gcal-to-discord
  labels:
    app: gcal-to-discord
    component: sync-job
spec:
  # Schedule: Every 30 minutes
  # Cron format: minute hour day month weekday
  schedule: "*/30 * * * *"

  # Timezone (requires Kubernetes 1.25+)
  # timeZone: "America/New_York"

  # Job history limits
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3

  # Concurrency policy
  # Forbid: Don't start new job if previous is still running
  concurrencyPolicy: Forbid

  # Deadline for starting the job (in seconds)
  startingDeadlineSeconds: 300

  jobTemplate:
    metadata:
      labels:
        app: gcal-to-discord
        component: sync-job
    spec:
      # Job will be deleted after 1 hour
      ttlSecondsAfterFinished: 3600

      # Backoff limit for failed pods
      backoffLimit: 2

      template:
        metadata:
          labels:
            app: gcal-to-discord
            component: sync-job
          annotations:
            # Istio: disable sidecar injection if using service mesh
            sidecar.istio.io/inject: "false"
        spec:
          restartPolicy: OnFailure

          # Security context for pod
          securityContext:
            runAsNonRoot: true
            runAsUser: 1000
            runAsGroup: 1000
            fsGroup: 1000
            seccompProfile:
              type: RuntimeDefault

          # Service account (optional - for RBAC)
          # serviceAccountName: gcal-to-discord

          # Init container to copy token to writable location
          initContainers:
            - name: init-token
              image: gcal-to-discord:latest
              command:
                - sh
                - -c
                - |
                  # Copy token from secret mount to writable location if it exists
                  if [ -f /app/secrets/google/token.json ]; then
                    cp /app/secrets/google/token.json /tmp/token.json
                    echo "Token copied to /tmp/token.json"
                  else
                    echo "No existing token found, will be created on first OAuth flow"
                  fi
              volumeMounts:
                - name: google-token
                  mountPath: /app/secrets/google/token.json
                  subPath: token.json
                  readOnly: true
                - name: tmp
                  mountPath: /tmp
              securityContext:
                allowPrivilegeEscalation: false
                readOnlyRootFilesystem: false
                runAsNonRoot: true
                runAsUser: 1000
                capabilities:
                  drop:
                    - ALL

          containers:
            - name: sync
              # Replace with your image registry and tag
              image: gcal-to-discord:latest
              imagePullPolicy: IfNotPresent

              # Run in one-shot mode with uv (--no-sync since deps are pre-installed in image)
              command: ["uv", "run", "--no-sync", "gcal-to-discord", "--once"]

              # Security context for container
              securityContext:
                allowPrivilegeEscalation: false
                readOnlyRootFilesystem: false
                runAsNonRoot: true
                runAsUser: 1000
                capabilities:
                  drop:
                    - ALL

              # Resource limits and requests
              resources:
                requests:
                  memory: "64Mi"
                  cpu: "50m"
                limits:
                  memory: "128Mi"
                  cpu: "200m"

              # Environment variables from ConfigMap
              envFrom:
                - configMapRef:
                    name: gcal-to-discord-config

              # Environment variables from Secrets
              env:
                - name: DISCORD_BOT_TOKEN
                  valueFrom:
                    secretKeyRef:
                      name: gcal2discord-discord-bot-token
                      key: token
                # UV cache directory (writable location for non-root user)
                - name: UV_CACHE_DIR
                  value: "/tmp/.uv-cache"

              # Volume mounts for credentials
              volumeMounts:
                - name: google-credentials
                  mountPath: /app/secrets/google/credentials.json
                  subPath: credentials.json
                  readOnly: true
                - name: google-token
                  mountPath: /app/secrets/google/token.json
                  subPath: token.json
                  readOnly: true
                - name: tmp
                  mountPath: /tmp

          volumes:
            # Mount Google credentials.json from secret
            - name: google-credentials
              secret:
                secretName: gcal2discord-google-credentials
                items:
                  - key: credentials.json
                    path: credentials.json

            # Mount Google token.json from secret (optional)
            - name: google-token
              secret:
                secretName: gcal2discord-google-token
                optional: true # Will be generated on first run if missing
                items:
                  - key: token.json
                    path: token.json

            # Shared writable tmp volume for token storage
            - name: tmp
              emptyDir: {}

          # Image pull secrets (if using private registry)
          # imagePullSecrets:
          # - name: registry-credentials
